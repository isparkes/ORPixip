<?xml version="1.0"?>
<config>
  <Application>
    Pixip
  </Application>

  <PipelineList>
    <PixipPipe>
      <Active>True</Active>
    </PixipPipe>
  </PipelineList>

  <PixipPipe>
    <!-- Input Adapter -->
    <InputAdapter>
      <PInpAdapter>
        <ClassName>Pixip.PixipDBInputAdapter</ClassName>
        <BatchSize>5000</BatchSize>
        <DataSource>mtn_poc_db</DataSource>
        <ValidateStatement>select count(*) from mtn_billing_cdr</ValidateStatement>
        <RecordCountStatement>select count(*) from mtn_billing_cdr where FIELD3 is null</RecordCountStatement>
        <InitStatement>update mtn_billing_cdr set FIELD3 = '1' where FIELD3 is null</InitStatement>
        <RecordSelectStatement>select mtn_cdr_id,
                                      ANUMBER,
                                      BNUMBER,
                                      CALL_DATE,
                                      CALL_DURATION,
                                      CHARGE_MAIN_ACCT,
                                      CALL_TYPE,
                                      PARTNER_OPTR,
                                      FNF_IND,
                                      SERVICE_CLASS,
                                      TELESERVICE_CODE,
                                      TRAFFIC_TYPE
                              from    mtn_billing_cdr r 
                              where   FIELD3 = '1'
        </RecordSelectStatement>
        <CommitStatement></CommitStatement>
        <RollbackStatement></RollbackStatement>
      </PInpAdapter>
    </InputAdapter>

    <!-- Processing Pipeline -->
    <Process>
      <!-- Dump Diagnostic Information -->
      <DumpFirst>
        <ClassName>OpenRate.process.Dump</ClassName>
        <Active>True</Active>
        <DumpType>All</DumpType>
        <DumpFilePath>Data/Pixip</DumpFilePath>
        <DumpFilePrefix>IP_VCP_</DumpFilePrefix>
        <DumpFileSuffix>.dump</DumpFileSuffix>
        <BatchSize>5000</BatchSize>
      </DumpFirst>
    </Process>

    <!-- Output Adapters -->
    <OutputAdapter>
      <CGoodOutAdapter>
        <ClassName>Pixip.PixipDBOutputAdapter</ClassName>
        <OutputName>GoodOutput</OutputName>
        <BatchSize>5000</BatchSize>
        <MaxSleep>50</MaxSleep>
        <DataSource>mtn_poc_db</DataSource>
        <ValidateStatement>select 1 from mtn_billing_cdr</ValidateStatement>
        <InitStatement>select 1 from mtn_billing_cdr</InitStatement>
        <RecordInsertStatement>update mtn_billing_cdr set FIELD3 = '2', FIELD4 =?, FIELD5 = ? where mtn_cdr_id=?</RecordInsertStatement>
        <CommitStatement>update mtn_billing_cdr set FIELD3 = '3' where FIELD3 = '2'</CommitStatement>
        <RollbackStatement>update mtn_billing_cdr set FIELD3 = '-1' where FIELD3 = '2'</RollbackStatement>
      </CGoodOutAdapter>
    </OutputAdapter>
  </PixipPipe>

  <Resource>
    <LogFactory>
      <ClassName>OpenRate.logging.LogFactory</ClassName>
      <Properties>logPixip.properties</Properties>
      <DefaultCategory>ConfigTest</DefaultCategory>
    </LogFactory>

    <ECI>
      <ClassName>OpenRate.configurationmanager.EventHandler</ClassName>
      <Port>8086</Port>
      <MaxConnection>2</MaxConnection>
      <SemaphoreFile>Semaphore/Semaphore.txt</SemaphoreFile>
    </ECI>

    <TransactionManagerFactory>
      <ClassName>OpenRate.transaction.TransactionManagerFactory</ClassName>
    </TransactionManagerFactory>

    <!-- Conversion Cache allows us to cache heavy coversion objects -->
    <ConversionCache>
      <ClassName>OpenRate.resource.ConversionCache</ClassName>
    </ConversionCache>

    <DataSourceFactory>
      <ClassName>OpenRate.resource.DataSourceFactory</ClassName>
      <DataSourceBuilder>
        <ClassName>OpenRate.db.C3P0DataSource</ClassName>
      </DataSourceBuilder>
      
      <DataSource>
        <mtn_poc_db>
          <db_url>jdbc:mysql://localhost/mtn_poc</db_url>
          <driver>com.mysql.jdbc.Driver</driver>
          <username>root</username>
          <password>cpr</password>
          <ValidationQuery>select 1 from dual</ValidationQuery>
          <InitQuery>select 1 from dual</InitQuery>
          <TestConnectionPeriod>60</TestConnectionPeriod>
        </mtn_poc_db>
      
        <PixipDB>
          <db_url>jdbc:mysql://localhost/PixipDB</db_url>
          <driver>com.mysql.jdbc.Driver</driver>
          <username>root</username>
          <password>cpr</password>
          <ValidationQuery>select 1 from dual</ValidationQuery>
          <InitQuery>select 1 from dual</InitQuery>
          <TestConnectionPeriod>60</TestConnectionPeriod>
        </PixipDB>
      </DataSource>
    </DataSourceFactory>

    <CacheFactory>
      <ClassName>OpenRate.resource.CacheFactory</ClassName>
      <ModuleName>CacheFactory</ModuleName>
      <CacheableClass>
        <!-- Number normalisation rules -->
        <NormCache>
          <ClassName>OpenRate.cache.RegexMatchCache</ClassName>
          <DataSourceType>DB</DataSourceType>
          <DataSource>PixipDB</DataSource>
          <SelectStatement>select MAP_GROUP,BAND,NUMBER,OLD_PREFIX,NEW_PREFIX from NORM_MAP order by RANK</SelectStatement>
          <KeyFields>2</KeyFields>
        </NormCache>

      </CacheableClass>
    </CacheFactory>

  </Resource>
</config>
